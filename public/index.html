<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bulk Sender Dashboard</title>
    <!-- QR Code Library -->  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-status {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #ff4444;
            animation: pulse 2s infinite;
        }

        .status-indicator.connected {
            background-color: #00ff00;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        @keyframes slideIn {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        /* Main Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e0e0e0;
            padding: 2rem 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
        }

        .sidebar-menu {
            list-style: none;
        }

        .menu-item {
            margin: 0.5rem 0;
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            text-decoration: none;
            color: #333;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .menu-link:hover,
        .menu-link.active {
            background-color: #f0f8ff;
            border-left-color: #25D366;
            color: #25D366;
        }

        .menu-icon {
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .menu-title {
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background-color: white;
        }

        .content-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .content-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .content-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-icon {
            font-size: 2rem;
            margin-right: 1rem;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .card-content {
            color: #666;
            line-height: 1.6;
        }

        /* QR Code Section */
        .qr-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            border: 2px dashed #dee2e6;
        }

        .qr-placeholder {
            width: 280px;
            height: 280px;
            background: #ffffff;
            margin: 0 auto 1rem;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #6c757d;
            border: 2px solid #dee2e6;
            padding: 10px;
        }

        .qr-placeholder img {
            max-width: 100%;
            max-height: 100%;
        }

        .qr-placeholder canvas {
            max-width: 100%;
            max-height: 100%;
        }

        /* Footer */
        .footer {
            background-color: #333;
            color: white;
            padding: 1rem 2rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .footer-links {
            margin-top: 0.5rem;
        }

        .footer-link {
            color: #25D366;
            text-decoration: none;
            margin: 0 1rem;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background-color: #25D366;
            color: white;
        }

        .btn-primary:hover {
            background-color: #128C7E;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem;
            border-radius: 5px;
            margin: 1rem 0;
            display: none;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .main-content {
                padding: 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <h1>üì± WhatsApp Bulk Sender Dashboard</h1>
        <div class="header-status">
            <button class="logout-btn" onclick="logout()">Logout</button>
            <span id="status-text">Disconnected</span>
            <div class="status-indicator" id="status-indicator"></div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <nav>
                <ul class="sidebar-menu">
                    <li class="menu-item">
                        <a href="#" class="menu-link active" onclick="showSection('dashboard')">
                            <span class="menu-icon">üìä</span>
                            <span class="menu-title">Dashboard</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" onclick="showSection('send-message')">
                            <span class="menu-icon">üì§</span>
                            <span class="menu-title">Send Message</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#" class="menu-link" onclick="showSection('contacts')">
                            <span class="menu-icon">üë•</span>
                            <span class="menu-title">Contacts</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard-section" class="content-section">
                <div class="content-header">
                    <h2 class="content-title">Dashboard Overview</h2>
                    <p class="content-subtitle">Monitor your WhatsApp Bulk Sender application</p>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üì±</div>
                            <div class="card-title">Connection Status</div>
                        </div>
                        <div class="card-content">
                            <p id="connection-status">Not Connected</p>
                            <button class="btn btn-primary" onclick="connectWhatsApp()">Connect</button>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üì§</div>
                            <div class="card-title">Messages Sent</div>
                        </div>
                        <div class="card-content">
                            <p><strong id="messages-sent">0</strong> messages sent today</p>
                            <p>Last sent: <span id="last-message-time">Never</span></p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">üë•</div>
                            <div class="card-title">Contact List</div>
                        </div>
                        <div class="card-content">
                            <p><strong id="contacts-count">0</strong> contacts loaded</p>
                            <p>Active contacts: <span id="active-contacts">0</span></p>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-icon">‚ö°</div>
                            <div class="card-title">Server Status</div>
                        </div>
                        <div class="card-content">
                            <p>Server running on port <strong>3000</strong></p>
                            <p>Uptime: <span id="server-uptime">--</span></p>
                        </div>
                    </div>
                </div>

                <!-- QR Code Section -->
                <div class="qr-section" id="qr-section" style="display: none;">
                    <h3>üì± QR Code for WhatsApp Connection</h3>
                    <div class="qr-placeholder" id="qr-placeholder">
                        ‚è≥
                    </div>
                    <p>Scan this QR code with your WhatsApp mobile app</p>
                    <p><strong id="qr-timer">Waiting for QR code...</strong></p>
                    <button class="btn btn-secondary" onclick="refreshQR()" style="margin-top: 1rem;">üîÑ Refresh QR Code</button>
                </div>
            </section>

            <!-- Send Message Section -->
            <section id="send-message-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">Send Message</h2>
                    <p class="content-subtitle">Upload contacts and send bulk messages</p>
                </div>

                <!-- File Upload Card -->
                <div class="dashboard-card" style="max-width: 800px; margin-bottom: 2rem;">
                    <div class="card-header">
                        <div class="card-icon">üìÑ</div>
                        <div class="card-title">Upload Contact List</div>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label for="excel-file" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Upload File:</label>
                                <input type="file" id="excel-file" accept=".csv,.xlsx,.xls" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                                <small style="color: #666;">CSV, Excel (.xlsx, .xls) files with columns like "phone", "number", "mobile" for phone numbers</small>
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-primary" onclick="uploadContacts()">üì§ Upload Contacts</button>
                                <button class="btn btn-secondary" onclick="clearContacts()">üóëÔ∏è Clear Contacts</button>
                            </div>

                            <div id="upload-status" style="margin-top: 1rem;">
                                <p><strong>Contacts Loaded:</strong> <span id="contacts-loaded">0</span></p>
                                <div id="contact-list-display" style="max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 1rem; margin-top: 0.5rem; border-radius: 5px; display: none;">
                                    <!-- Contact list will be displayed here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Message Configuration Card -->
                <div class="dashboard-card" style="max-width: 800px; margin-bottom: 2rem;">
                    <div class="card-header">
                        <div class="card-icon">üìù</div>
                        <div class="card-title">Message Configuration</div>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label for="message-text" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Message Text:</label>
                                <textarea id="message-text" rows="4" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Enter your message here..."></textarea>
                                <small style="color: #666;">
                                    üí° <strong>Tip:</strong> Use spintax like {Hi|Hello} {there|boss} for natural variations!
                                </small>
                            </div>

                            <div>
                                <label for="delay-time" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Delay between messages (seconds):</label>
                                <input type="number" id="delay-time" value="30" min="5" max="60" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;">
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-primary" onclick="sendMessages()">üì§ Send Bulk Messages</button>
                                <button class="btn btn-secondary" onclick="stopSending()">‚èπÔ∏è Stop Sending</button>
                                <button class="btn btn-secondary" onclick="previewMessages()">üëÅÔ∏è Preview</button>
                            </div>

                            <!-- Progress Section -->
                            <div id="progress-section" style="display: none; margin-top: 1rem;">
                                <div style="background: #f8f9fa; padding: 1rem; border-radius: 5px;">
                                    <h4>üìä Sending Progress</h4>
                                    <p>Progress: <span id="progress-current">0</span> / <span id="progress-total">0</span></p>
                                    <p>Remaining: <span id="progress-remaining">0</span></p>
                                    <div style="background: #e9ecef; height: 20px; border-radius: 10px; margin-top: 0.5rem;">
                                        <div id="progress-bar" style="background: #25D366; height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div class="status-message status-info" id="send-status">
                    Ready to send messages. Please upload contacts and connect to WhatsApp first.
                </div>
                
                <!-- Sending Progress Section -->
                <div class="dashboard-card" id="sending-progress-section" style="max-width: 800px; margin-top: 2rem; display: none;">
                    <div class="card-header">
                        <div class="card-icon">üì§</div>
                        <div class="card-title">Sending Progress</div>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <h4>üìä Current Status</h4>
                                <p id="current-sending-status">Not sending</p>
                            </div>
                            <div>
                                <h4>üì± Current Contact</h4>
                                <p id="current-contact-info">-</p>
                            </div>
                            <div>
                                <h4>‚è±Ô∏è Progress</h4>
                                <p>Sent: <strong id="sent-count">0</strong> / <strong id="total-count">0</strong></p>
                                <p>Failed: <strong id="failed-count">0</strong></p>
                                <p>Remaining: <strong id="remaining-count">0</strong></p>
                            </div>
                            <div>
                                <h4>üìù Message Logs</h4>
                                <div id="message-logs" style="max-height: 300px; overflow-y: auto; border: 1px solid #eee; padding: 1rem; background: #f8f9fa; border-radius: 5px; margin-top: 0.5rem;">
                                    <p style="color: #666; text-align: center;">No messages sent yet</p>
                                </div>
                            </div>
                            <div style="background: #e9ecef; height: 20px; border-radius: 10px; margin-top: 1rem;">
                                <div id="progress-bar" style="background: #25D366; height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s ease;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contacts Section -->
            <section id="contacts-section" class="content-section" style="display: none;">
                <div class="content-header">
                    <h2 class="content-title">Contacts</h2>
                    <p class="content-subtitle">Manage your contact list</p>
                </div>

                <!-- Add Manual Contact -->
                <div class="dashboard-card" style="max-width: 600px; margin-bottom: 2rem;">
                    <div class="card-header">
                        <div class="card-icon">‚ûï</div>
                        <div class="card-title">Add Manual Contact</div>
                    </div>
                    <div class="card-content">
                        <div style="display: grid; gap: 1rem;">
                            <div>
                                <label for="manual-phone" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Phone Number:</label>
                                <input type="tel" id="manual-phone" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Enter phone number (e.g., 923422187767)">
                            </div>
                            <div>
                                <label for="manual-name" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Name (Optional):</label>
                                <input type="text" id="manual-name" style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 5px;" placeholder="Enter name">
                            </div>
                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-primary" onclick="addManualContact()">‚ûï Add Contact</button>
                                <button class="btn btn-danger" onclick="clearAllContacts()">üóëÔ∏è Clear All</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact List -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <div class="card-icon">üìã</div>
                        <div class="card-title">Contact List</div>
                    </div>
                    <div class="card-content">
                        <div id="contact-list-display" style="max-height: 400px; overflow-y: auto;">
                            <p>No contacts loaded yet. Upload a file or add manually.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Footer -->
    <!-- <footer class="footer">
        <div>¬© 2024 WhatsApp Bulk Sender Dashboard. All rights reserved.</div>
        <div class="footer-links">
            <a href="#" class="footer-link">Documentation</a>
            <a href="#" class="footer-link">Support</a>
            <a href="#" class="footer-link">GitHub</a>
        </div>
    </footer> -->

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Global variables
        let socket;

        // ============ GLOBAL FUNCTIONS (accessible from onclick handlers) ============

        // WhatsApp Connection
        async function connectWhatsApp() {
            const statusIndicator = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            const connectionStatus = document.getElementById('connection-status');
            const qrSection = document.getElementById('qr-section');

            try {
                // Check current status
                statusText.textContent = 'Connecting...';
                statusIndicator.classList.remove('connected');

                // Fetch current status from server
                const statusResponse = await fetch('/status');
                const statusData = await statusResponse.json();

                if (statusData.connected) {
                    statusText.textContent = 'Connected';
                    statusIndicator.classList.add('connected');
                    connectionStatus.textContent = 'Connected to WhatsApp';
                    showStatusMessage('Already connected to WhatsApp!', 'success');
                    return;
                }

                if (statusData.qrAvailable) {
                    // Show existing QR code
                    await displayQRCode();
                } else {
                    // Trigger new connection
                    statusText.textContent = 'Initializing...';
                    connectionStatus.textContent = 'Initializing WhatsApp connection...';

                    // Wait a moment and check for QR code
                    setTimeout(async () => {
                        await displayQRCode();
                    }, 2000);
                }

                // Start monitoring connection status
                monitorConnection();
            } catch (error) {
                console.error('Connection error:', error);
                statusText.textContent = 'Error';
                showStatusMessage('Failed to connect to WhatsApp: ' + error.message, 'error');
            }
        }

        // Display QR Code
        async function displayQRCode() {
            try {
                const qrResponse = await fetch('/qr');
                const qrData = await qrResponse.json();
                console.log('QR data:', qrData);

                if (qrData.qr) {
                    const qrSection = document.getElementById('qr-section');
                    const qrPlaceholder = document.getElementById('qr-placeholder');
                    const statusText = document.getElementById('status-text');
                    const connectionStatus = document.getElementById('connection-status');

                    // Clear previous QR code
                    qrPlaceholder.innerHTML = '';

                    // Generate QR code using QRCode.js
                    new QRCode(qrPlaceholder, {
                        text: qrData.qr,
                        width: 256,
                        height: 256,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });

                    statusText.textContent = 'Waiting for scan...';
                    connectionStatus.textContent = 'QR Code Generated - Scan with WhatsApp';
                    qrSection.style.display = 'block';

                    // Update timer
                    document.getElementById('qr-timer').textContent = 'Scan this QR code now (expires in ~60 seconds)';

                    showStatusMessage('QR Code generated! Scan with your WhatsApp mobile app.', 'success');
                } else {
                    // QR not ready yet
                    const qrPlaceholder = document.getElementById('qr-placeholder');
                    qrPlaceholder.innerHTML = '‚è≥<br><small>Generating QR code...</small>';

                    // Retry after 3 seconds
                    setTimeout(displayQRCode, 3000);
                }
            } catch (error) {
                console.error('QR display error:', error);
                const qrPlaceholder = document.getElementById('qr-placeholder');
                qrPlaceholder.innerHTML = '‚ùå<br><small>QR code not ready yet. Please wait...</small>';

                // Retry after 3 seconds
                setTimeout(displayQRCode, 3000);
            }
        }

        // Refresh QR Code
        async function refreshQR() {
            try {
                showStatusMessage('Refreshing QR code...', 'info');

                // Clear auth to generate new QR
                const response = await fetch('/clear-auth', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showStatusMessage('Generating new QR code...', 'info');

                    // Wait for new QR code
                    setTimeout(async () => {
                        await displayQRCode();
                    }, 3000);
                }
            } catch (error) {
                console.error('Refresh QR error:', error);
                showStatusMessage('Failed to refresh QR code: ' + error.message, 'error');
            }
        }

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.style.display = 'none';
            });

            // Remove active class from all menu items
            const menuLinks = document.querySelectorAll('.menu-link');
            menuLinks.forEach(link => {
                link.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionName + '-section').style.display = 'block';

            // Add active class to clicked menu item
            event.target.closest('.menu-link').classList.add('active');
        }

        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout? This will also disconnect your WhatsApp session.')) {
                try {
                    const token = localStorage.getItem('token');
                    if (token) {
                        // First, logout from WhatsApp
                        const whatsappLogoutResponse = await fetch('/api/whatsapp/logout', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        const whatsappLogoutData = await whatsappLogoutResponse.json();
                        if (!whatsappLogoutResponse.ok) {
                            console.error('WhatsApp logout error:', whatsappLogoutData.error);
                            // Continue with logout even if WhatsApp logout fails
                        } else {
                            console.log('WhatsApp logout successful:', whatsappLogoutData.message);
                        }
                        
                        // Then logout from authentication
                        await fetch('/api/auth/logout', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    }
                } catch (error) {
                    console.error('Logout API error:', error);
                    // Continue with logout even if API call fails
                }

                // Clear local storage
                localStorage.removeItem('token');
                localStorage.removeItem('user');

                // Redirect to login page
                window.location.href = '/';
            }
        }

        // Upload Contacts
        async function uploadContacts() {
            const fileInput = document.getElementById('excel-file');
            const file = fileInput.files[0];

            if (!file) {
                showStatusMessage('Please select a file to upload.', 'error');
                return;
            }

            if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.xlsx') && !file.name.toLowerCase().endsWith('.xls')) {
                showStatusMessage('Please select a CSV or Excel file.', 'error');
                return;
            }

            try {
                showStatusMessage('Processing file...', 'info');

                let phoneNumbers = [];

                if (file.name.toLowerCase().endsWith('.csv')) {
                    // Process CSV
                    const text = await file.text();
                    const lines = text.split('\n').map(line => line.trim()).filter(line => line);

                    if (lines.length === 0) {
                        showStatusMessage('CSV file is empty.', 'error');
                        return;
                    }

                    // Check if first line is header
                    const firstLine = lines[0].toLowerCase();
                    const hasHeader = firstLine.includes('phone') || firstLine.includes('number') || firstLine.includes('mobile');

                    let dataLines = lines;
                    let phoneIndex = 0;
                    let nameIndex = 1;

                    if (hasHeader) {
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        phoneIndex = headers.findIndex(h => h.includes('phone') || h.includes('number') || h.includes('mobile'));
                        nameIndex = headers.findIndex(h => h.includes('name'));
                        dataLines = lines.slice(1);
                    }

                    for (const line of dataLines) {
                        const parts = line.split(',');
                        if (parts.length > phoneIndex) {
                            const number = parts[phoneIndex] ? parts[phoneIndex].trim() : '';
                            const name = (nameIndex !== -1 && parts[nameIndex]) ? parts[nameIndex].trim() : '';
                            if (number) {
                                phoneNumbers.push({ number, name });
                            }
                        }
                    }
                } else {
                    // Process Excel - load XLSX library dynamically
                    try {
                        // Check if XLSX is already loaded
                        if (typeof XLSX === 'undefined') {
                            // Dynamically load the library
                            const script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
                            script.onload = function() {
                                console.log('XLSX library loaded successfully');
                                // Retry the upload after library loads
                                uploadContacts();
                            };
                            script.onerror = function() {
                                showStatusMessage('Failed to load Excel processing library. Please try again.', 'error');
                            };
                            document.head.appendChild(script);
                            return; // Wait for library to load
                        }
    
                        const data = await file.arrayBuffer();
                        const workbook = XLSX.read(data);
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
    
                        if (jsonData.length === 0) {
                            showStatusMessage('Excel file is empty.', 'error');
                            return;
                        }
    
                        // Find phone and name columns
                        const headers = Object.keys(jsonData[0]);
                        const phoneIndex = headers.findIndex(h => h.toLowerCase().includes('phone') || h.toLowerCase().includes('number') || h.toLowerCase().includes('mobile') || h.toLowerCase().includes('phone_number') || h.toLowerCase().includes('numbers'));
                        const nameIndex = headers.findIndex(h => h.toLowerCase().includes('name'));
    
                        for (const row of jsonData) {
                            const number = row[headers[phoneIndex]] ? String(row[headers[phoneIndex]]).trim() : '';
                            const name = (nameIndex !== -1 && row[headers[nameIndex]]) ? String(row[headers[nameIndex]]).trim() : '';
                            if (number) {
                                phoneNumbers.push({ number, name });
                            }
                        }
                    } catch (excelError) {
                        console.error('Excel processing error:', excelError);
                        showStatusMessage('Error processing Excel file: ' + excelError.message, 'error');
                        return;
                    }
                }

                if (phoneNumbers.length === 0) {
                    showStatusMessage('No valid phone numbers found in the file.', 'error');
                    return;
                }

                // Send to server
                const response = await fetch('/upload-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contacts: phoneNumbers })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('contacts-loaded').textContent = phoneNumbers.length;
                    showStatusMessage(`Successfully loaded ${phoneNumbers.length} contacts.`, 'success');

                    // Display contacts
                    displayContacts(phoneNumbers);

                    // Update dashboard stats
                    updateDashboardStats(phoneNumbers.length);
                } else {
                    showStatusMessage('Upload failed: ' + (result.error || 'Unknown error'), 'error');
                }

            } catch (error) {
                console.error('Upload error:', error);
                showStatusMessage('Error processing file: ' + error.message, 'error');
            }
        }

        // Add Manual Contact
        async function addManualContact() {
            const phone = document.getElementById('manual-phone').value.trim();
            const name = document.getElementById('manual-name').value.trim();

            if (!phone) {
                showStatusMessage('Please enter a phone number.', 'error');
                return;
            }

            try {
                const response = await fetch('/upload-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contacts: [{ number: phone, name: name }] })
                });

                const result = await response.json();

                if (result.success) {
                    showStatusMessage('Contact added successfully!', 'success');
                    document.getElementById('manual-phone').value = '';
                    document.getElementById('manual-name').value = '';

                    // Update display
                    await loadContacts();
                } else {
                    showStatusMessage('Failed to add contact: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Add contact error:', error);
                showStatusMessage('Error adding contact: ' + error.message, 'error');
            }
        }

        // Clear Contacts
        function clearContacts() {
            document.getElementById('excel-file').value = '';
            document.getElementById('contacts-loaded').textContent = '0';
            document.getElementById('contact-list-display').style.display = 'none';
            showStatusMessage('Contact list cleared.', 'info');
            updateDashboardStats(0);
        }

        // Clear All Contacts
        async function clearAllContacts() {
            if (!confirm('Are you sure you want to clear all contacts?')) {
                return;
            }

            try {
                // Clear contacts on server
                const response = await fetch('/upload-contacts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contacts: [] })
                });

                const result = await response.json();

                if (result.success) {
                    showStatusMessage('All contacts cleared!', 'success');

                    // Update display
                    displayContacts([]);
                    updateDashboardStats(0);
                    document.getElementById('contacts-loaded').textContent = '0';
                } else {
                    showStatusMessage('Error clearing contacts.', 'error');
                }
            } catch (error) {
                console.error('Clear contacts error:', error);
                showStatusMessage('Error clearing contacts: ' + error.message, 'error');
            }
        }

        // Stop Sending
        function stopSending() {
            try {
                if (socket) {
                    socket.emit('stopSending');
                    showStatusMessage('Stop signal sent to server.', 'info');
                    document.getElementById('progress-section').style.display = 'none';
                } else {
                    showStatusMessage('Socket connection not available.', 'error');
                }
            } catch (error) {
                console.error('Stop sending error:', error);
                showStatusMessage('Error stopping send process: ' + error.message, 'error');
            }
        }

        // Send Messages
        async function sendMessages() {
            const messageText = document.getElementById('message-text').value;
            const delay = parseInt(document.getElementById('delay-time').value) || 30;

            if (!messageText.trim()) {
                showStatusMessage('Please enter a message text.', 'error');
                return;
            }

            // Check connection status first
            try {
                const statusResponse = await fetch('/status');
                const statusData = await statusResponse.json();

                if (!statusData.connected) {
                    showStatusMessage('Please connect to WhatsApp first!', 'error');
                    return;
                }

                if (statusData.progress.total === 0) {
                    showStatusMessage('Please upload a file with phone numbers first!', 'error');
                    return;
                }

                const hasSpintax = /\{[^}]+\}/.test(messageText);

                if (hasSpintax) {
                    showStatusMessage(`Starting bulk message sending to ${statusData.progress.total} contacts with spintax variations...`, 'info');
                } else {
                    showStatusMessage(`Starting bulk message sending to ${statusData.progress.total} contacts...`, 'info');
                }

                // Show progress section
                document.getElementById('sending-progress-section').style.display = 'block';
                document.getElementById('sent-count').textContent = '0';
                document.getElementById('total-count').textContent = statusData.progress.total;
                document.getElementById('failed-count').textContent = '0';
                document.getElementById('remaining-count').textContent = statusData.progress.total;
                document.getElementById('current-sending-status').textContent = 'Initializing...';
                document.getElementById('current-contact-info').textContent = '-';
                document.getElementById('message-logs').innerHTML = '<p style="color: #666; text-align: center;">Sending started...</p>';
                document.getElementById('progress-bar').style.width = '0%';

                // Send bulk message request via socket.io
                socket.emit('startSending', {
                    message: messageText,
                    delay: delay,
                    useSpintax: hasSpintax
                });

                document.getElementById('last-message-time').textContent = new Date().toLocaleTimeString();
                showStatusMessage(`Started sending to ${statusData.progress.total} contacts`, 'success');
            } catch (error) {
                console.error('Send message error:', error);
                showStatusMessage('Error sending messages: ' + error.message, 'error');
            }
        }

        // Preview Messages
        async function previewMessages() {
            const messageText = document.getElementById('message-text').value;
            const contactsLoaded = parseInt(document.getElementById('contacts-loaded').textContent);

            if (!messageText.trim()) {
                showStatusMessage('Please enter a message for preview.', 'error');
                return;
            }

            if (contactsLoaded === 0) {
                showStatusMessage('Please upload contacts first for preview.', 'error');
                return;
            }

            try {
                const statusResponse = await fetch('/status');
                const statusData = await statusResponse.json();

                const preview = `"${messageText}" will be sent to ${statusData.progress.total} contacts`;
                showStatusMessage(preview, 'info');
            } catch (error) {
                const preview = `"${messageText}" will be sent to ${contactsLoaded} contacts`;
                showStatusMessage(preview, 'info');
            }
        }

        // ============ SUPPORTING FUNCTIONS ============

        // Monitor connection status
        async function monitorConnection() {
            const checkInterval = setInterval(async () => {
                try {
                    const response = await fetch('/status');
                    const data = await response.json();

                    const statusIndicator = document.getElementById('status-indicator');
                    const statusText = document.getElementById('status-text');
                    const connectionStatus = document.getElementById('connection-status');
                    const qrSection = document.getElementById('qr-section');

                    if (data.connected) {
                        statusText.textContent = 'Connected';
                        statusIndicator.classList.add('connected');
                        connectionStatus.textContent = 'Connected to WhatsApp';
                        qrSection.style.display = 'none';
                        clearInterval(checkInterval);
                        showStatusMessage('Successfully connected to WhatsApp!', 'success');
                    }
                } catch (error) {
                    console.error('Status check error:', error);
                }
            }, 2000);
        }

        // Display Contacts
        function displayContacts(phoneNumbers) {
            const contactDisplay = document.getElementById('contact-list-display');

            if (!phoneNumbers || phoneNumbers.length === 0) {
                contactDisplay.innerHTML = '<p>No contacts loaded yet. Upload a file or add manually.</p>';
                return;
            }

            const displayContacts = phoneNumbers.slice(0, 100); // Show first 100 contacts

            contactDisplay.innerHTML = `
                <p><strong>Total Contacts: ${phoneNumbers.length}</strong></p>
                <div style="margin-top: 1rem;">
                    ${displayContacts.map((contact, index) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee;">
                            <div>
                                <strong>${index + 1}.</strong> ${contact.number}${contact.name ? ` (${contact.name})` : ''}
                            </div>
                            <button class="btn btn-sm" style="background: #dc3545; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px;" onclick="removeContact(${index})">‚ùå</button>
                        </div>
                    `).join('')}
                    ${phoneNumbers.length > 100 ? `<p style="margin-top: 1rem;"><em>...and ${phoneNumbers.length - 100} more</em></p>` : ''}
                </div>
            `;
            contactDisplay.style.display = 'block';
        }

        // Remove Contact
        async function removeContact(index) {
            try {
                // Get current contacts
                const contactsResponse = await fetch('/contacts');
                const contactsData = await contactsResponse.json();

                if (contactsData.contacts && contactsData.contacts.length > index) {
                    // Remove the contact
                    contactsData.contacts.splice(index, 1);

                    // Send updated contacts to server
                    const response = await fetch('/upload-contacts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ contacts: [] }) // Clear and re-add
                    });

                    if (response.ok) {
                        // Re-add remaining contacts
                        const addResponse = await fetch('/upload-contacts', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ contacts: contactsData.contacts })
                        });

                        if (addResponse.ok) {
                            showStatusMessage('Contact removed successfully!', 'success');
                            await loadContacts();
                        } else {
                            showStatusMessage('Error updating contacts after removal.', 'error');
                        }
                    } else {
                        showStatusMessage('Error removing contact.', 'error');
                    }
                }
            } catch (error) {
                console.error('Remove contact error:', error);
                showStatusMessage('Error removing contact: ' + error.message, 'error');
            }
        }

        
        // Update message logs
        function addMessageLog(number, name, message, status) {
            const logsDiv = document.getElementById('message-logs');
            const logEntry = document.createElement('div');
            
            const timestamp = new Date().toLocaleTimeString();
            const displayName = name || number;
            
            logEntry.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; margin: 0.25rem 0; background: ${status === 'sent' ? '#d4edda' : status === 'failed' ? '#f8d7da' : '#d1ecf1'}; border-left: 4px solid ${status === 'sent' ? '#28a745' : status === 'failed' ? '#dc3545' : '#0c5460'}; border-radius: 4px;">
                    <div style="flex: 1;">
                        <strong>${timestamp}</strong> - ${displayName}
                        <div style="font-size: 0.9em; color: #666; margin-top: 0.25rem;">${message.substring(0, 50)}${message.length > 50 ? '...' : ''}</div>
                    </div>
                    <span style="margin-left: 1rem; font-weight: bold; color: ${status === 'sent' ? '#28a745' : status === 'failed' ? '#dc3545' : '#0c5460'};">${status.toUpperCase()}</span>
                </div>
            `;
            
            logsDiv.prepend(logEntry);
            
            // Auto-scroll to show newest logs
            logsDiv.scrollTop = 0;
        }
        
        // Update current sending status
        function updateCurrentSending(number, name, status) {
            const displayName = name || number;
            document.getElementById('current-contact-info').textContent = displayName;
            document.getElementById('current-sending-status').textContent = status;
        }

        // Update Dashboard Stats
        function updateDashboardStats(contactsCount) {
            document.getElementById('contacts-count').textContent = contactsCount;
            document.getElementById('active-contacts').textContent = contactsCount;
        }

        // Status Messages
        function showStatusMessage(message, type) {
            const statusElement = document.getElementById('send-status');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Load contacts from server
        async function loadContacts() {
            try {
                // Get contacts
                const contactsResponse = await fetch('/contacts');
                const contactsData = await contactsResponse.json();

                const contactCount = contactsData.contacts ? contactsData.contacts.length : 0;

                updateDashboardStats(contactCount);
                document.getElementById('contacts-loaded').textContent = contactCount;

                // Display contacts in contacts section
                displayContacts(contactsData.contacts || []);

                if (contactCount > 0) {
                    showStatusMessage(`${contactCount} contacts loaded`, 'info');
                }
            } catch (error) {
                console.log('Error loading contacts:', error);
            }
        }

        // Update dashboard status
        async function updateDashboardStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();

                // Update connection status
                const statusIndicator = document.getElementById('status-indicator');
                const statusText = document.getElementById('status-text');

                if (data.connected) {
                    statusText.textContent = 'Connected';
                    statusIndicator.classList.add('connected');
                    document.getElementById('connection-status').textContent = 'Connected to WhatsApp';
                } else {
                    statusText.textContent = 'Disconnected';
                    statusIndicator.classList.remove('connected');
                    document.getElementById('connection-status').textContent = 'Not Connected';
                }

                // Update messages sent count
                if (data.progress) {
                    document.getElementById('messages-sent').textContent = data.progress.current || 0;
                }

            } catch (error) {
                console.error('Error updating dashboard status:', error);
            }
        }

        // Check for QR code availability
        async function checkForQRCode() {
            try {
                const statusResponse = await fetch('/status');
                const statusData = await statusResponse.json();
                console.log('Status data:', statusData);

                const qrSection = document.getElementById('qr-section');

                if (statusData.connected) {
                    // Hide QR section if connected
                    qrSection.style.display = 'none';
                } else if (statusData.qrAvailable) {
                    // Show QR code if available and not connected
                    await displayQRCode();
                }
            } catch (error) {
                console.log('QR check error:', error);
            }
        }

        function formatUptime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // ============ INITIALIZATION ============

        // Authentication check
        document.addEventListener('DOMContentLoaded', async function() {
            const token = localStorage.getItem('token');
            if (!token) {
                // Redirect to login if no token
                window.location.href = '/login.html';
                return;
            }

            // Verify token with server
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    // Token invalid, redirect to login
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login.html';
                    return;
                }

                const userData = await response.json();
                if (userData.success) {
                    // Store user data
                    localStorage.setItem('user', JSON.stringify(userData.user));
                    console.log('Authenticated user:', userData.user.name);
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
                return;
            }

            // Initialize Socket.io
            socket = io();

            // Socket event handlers
            socket.on('qr', (qr) => {
                console.log('QR received via socket');
                // Immediately display QR when received
                const qrSection = document.getElementById('qr-section');
                const qrPlaceholder = document.getElementById('qr-placeholder');
                const statusText = document.getElementById('status-text');
                const connectionStatus = document.getElementById('connection-status');
                const connectBtn = document.querySelector('.btn-primary[onclick="connectWhatsApp()"]');
    
                // Clear previous QR code
                qrPlaceholder.innerHTML = '';
    
                // Generate QR code using QRCode.js
                new QRCode(qrPlaceholder, {
                    text: qr,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
    
                statusText.textContent = 'Waiting for scan...';
                connectionStatus.textContent = 'QR Code Generated - Scan with WhatsApp';
                qrSection.style.display = 'block';
    
                // Update timer
                document.getElementById('qr-timer').textContent = 'Scan this QR code now (expires in ~60 seconds)';
    
                // Change button to Disconnect
                if (connectBtn) {
                    connectBtn.textContent = 'Disconnect WhatsApp';
                    connectBtn.onclick = function() {
                        logout();
                    };
                }
    
                showStatusMessage('QR Code generated! Scan with your WhatsApp mobile app.', 'success');
            });

            // Socket event handlers for progress tracking
            socket.on('sendProgress', (data) => {
                document.getElementById('sent-count').textContent = data.sent;
                document.getElementById('total-count').textContent = data.total;
                document.getElementById('current-contact-info').textContent = data.currentName || data.currentNumber || '-';
                document.getElementById('current-sending-status').textContent = data.status || 'Sending...';
                
                const percentage = data.total > 0 ? (data.sent / data.total) * 100 : 0;
                document.getElementById('progress-bar').style.width = percentage + '%';
                
                if (data.sent === data.total) {
                    showStatusMessage('All messages sent successfully!', 'success');
                    document.getElementById('sending-progress-section').style.display = 'block';
                }
            });

            socket.on('messageStatus', (data) => {
                addMessageLog(data.number, data.name, data.message, data.status);
            });

            socket.on('contactsUpdated', (data) => {
                // Update contacts display when contacts are updated
                loadContacts();
            });

            // Load contacts from server and update status
            await loadContacts();
            await updateDashboardStatus();

            // Check for QR code on page load
            await checkForQRCode();

            // Simulate server uptime
            let uptime = 0;
            setInterval(() => {
                uptime++;
                document.getElementById('server-uptime').textContent = formatUptime(uptime);
            }, 1000);

            // Update dashboard status every 5 seconds
            setInterval(updateDashboardStatus, 5000);

            // Check for QR code every 3 seconds
            setInterval(checkForQRCode, 3000);
        });
    </script>
</body>
</html>